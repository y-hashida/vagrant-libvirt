<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Examples - Vagrant Libvirt Documentation</title> <link rel="shortcut icon" href="/vagrant-libvirt/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/vagrant-libvirt/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/vagrant-libvirt/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/vagrant-libvirt/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Examples | Vagrant Libvirt Documentation</title> <meta name="generator" content="Jekyll v3.9.3" /> <meta property="og:title" content="Examples" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Create and manage Vagrant machines using Libvirt/QEMU" /> <meta property="og:description" content="Create and manage Vagrant machines using Libvirt/QEMU" /> <link rel="canonical" href="https://vagrant-libvirt.github.io/vagrant-libvirt/examples.html" /> <meta property="og:url" content="https://vagrant-libvirt.github.io/vagrant-libvirt/examples.html" /> <meta property="og:site_name" content="Vagrant Libvirt Documentation" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Examples" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Create and manage Vagrant machines using Libvirt/QEMU","headline":"Examples","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://vagrant-libvirt.github.io/vagrant-libvirt/assets/images/logo.png"}},"url":"https://vagrant-libvirt.github.io/vagrant-libvirt/examples.html"}</script> <!-- End Jekyll SEO tag --> <link rel="stylesheet" href="/vagrant-libvirt/assets/css/just-the-docs-light.css" media="(prefers-color-scheme: light)"> <link rel="stylesheet" href="/vagrant-libvirt/assets/css/just-the-docs-dark.css" media="(prefers-color-scheme: dark)"> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="https://vagrant-libvirt.github.io/vagrant-libvirt/" class="site-title lh-tight"> <div class="site-logo"></div> Vagrant Libvirt Documentation </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="https://vagrant-libvirt.github.io/vagrant-libvirt/" class="nav-list-link">Quickstart</a> </li><li class="nav-list-item"><a href="https://vagrant-libvirt.github.io/vagrant-libvirt/installation.html" class="nav-list-link">Installation</a> </li><li class="nav-list-item"><a href="https://vagrant-libvirt.github.io/vagrant-libvirt/configuration.html" class="nav-list-link">Configuration</a> </li><li class="nav-list-item"><a href="https://vagrant-libvirt.github.io/vagrant-libvirt/boxes.html" class="nav-list-link">Boxes</a> </li><li class="nav-list-item active"><a href="https://vagrant-libvirt.github.io/vagrant-libvirt/examples.html" class="nav-list-link active">Examples</a> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h2"><a href="#no-box-and-pxe-boot">No box and PXE boot</a></li> <li class="toc-entry toc-h2"><a href="#using-kernel-and-initrd">Using kernel and initrd</a></li> <li class="toc-entry toc-h2"><a href="#ssh-access-to-vm">SSH Access To VM</a></li> <li class="toc-entry toc-h2"><a href="#forwarded-ports">Forwarded Ports</a></li> <li class="toc-entry toc-h2"><a href="#forwarding-the-ssh-port">Forwarding the ssh-port</a></li> <li class="toc-entry toc-h2"><a href="#synced-folders">Synced Folders</a></li> <li class="toc-entry toc-h2"><a href="#qemu-session-support">QEMU Session Support</a></li> <li class="toc-entry toc-h2"><a href="#customized-graphics">Customized Graphics</a></li> <li class="toc-entry toc-h2"><a href="#tpm-devices">TPM Devices</a></li> <li class="toc-entry toc-h2"><a href="#smbios-system-information">SMBIOS System Information</a></li> <li class="toc-entry toc-h2"><a href="#memory-balloon">Memory balloon</a></li> <li class="toc-entry toc-h2"><a href="#secure-encryption-virtualization-sev">Secure Encryption Virtualization (SEV)</a></li> <li class="toc-entry toc-h2"><a href="#libvirt-communication-channels">Libvirt communication channels</a></li> <li class="toc-entry toc-h2"><a href="#custom-qemu-arguments-and-environment-variables">Custom QEMU arguments and environment variables</a></li> </ul> </li><li class="nav-list-item"><a href="https://vagrant-libvirt.github.io/vagrant-libvirt/packaging.html" class="nav-list-link">Packaging</a> </li><li class="nav-list-item"><a href="https://vagrant-libvirt.github.io/vagrant-libvirt/troubleshooting.html" class="nav-list-link">Troubleshooting</a> </li><li class="nav-list-item"><a href="https://vagrant-libvirt.github.io/vagrant-libvirt/about/" class="nav-list-link">About</a> </li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Vagrant Libvirt Documentation" aria-label="Search Vagrant Libvirt Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <script src="/vagrant-libvirt/assets/js/site_constants-8a4bed1943880eb517645559355084dd5e8e4420fa19446028000099cd88351c.js"></script> <div id="plugin-version-menu" class="site-footer"></div> <script src="/vagrant-libvirt/assets/js/plugin_versions_menu.js"></script> </div> <div id="main-content-wrap" class="main-content-wrap"> <div id="main-content" class="main-content" role="main"> <p>Examples of specific use cases, and/or in-depth configuration for special behaviour.</p> <h2 id="no-box-and-pxe-boot"> <a href="#no-box-and-pxe-boot" class="anchor-heading" aria-labelledby="no-box-and-pxe-boot"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> No box and PXE boot </h2> <p>There is support for PXE booting VMs with no disks as well as PXE booting VMs with blank disks. There are some limitations:</p> <ul> <li>Requires Vagrant 1.6.0 or newer</li> <li>No provisioning scripts are ran</li> <li>No network configuration is being applied to the VM</li> <li>No SSH connection can be made</li> <li><code class="language-plaintext highlighter-rouge">vagrant halt</code> will only work cleanly if the VM handles ACPI shutdown signals</li> </ul> <p>In short, VMs without a box can be created, halted and destroyed but all other functionality cannot be used.</p> <p>An example for a PXE booted VM with no disks whatsoever:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="ss">:pxeclient</span> <span class="k">do</span> <span class="o">|</span><span class="n">pxeclient</span><span class="o">|</span>
    <span class="n">pxeclient</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">domain</span><span class="o">|</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">boot</span> <span class="s1">'network'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>And an example for a PXE booted VM with no box but a blank disk which will boot from this HD if the NICs fail to PXE boot:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="ss">:pxeclient</span> <span class="k">do</span> <span class="o">|</span><span class="n">pxeclient</span><span class="o">|</span>
    <span class="n">pxeclient</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">domain</span><span class="o">|</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">storage</span> <span class="ss">:file</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="s1">'100G'</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'qcow2'</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">boot</span> <span class="s1">'network'</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">boot</span> <span class="s1">'hd'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Example for vm with 2 networks and only 1 is bootable and has dhcp server in this subnet, for example foreman with dhcp server Name of network “foreman_managed” is key for define boot order</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="ss">:pxeclient</span> <span class="k">do</span> <span class="o">|</span><span class="n">pxeclient</span><span class="o">|</span>
      <span class="n">pxeclient</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="ss">:private_network</span><span class="p">,</span><span class="ss">ip: </span><span class="s1">'10.0.0.5'</span><span class="p">,</span>
            <span class="ss">libvirt__network_name: </span><span class="s2">"foreman_managed"</span><span class="p">,</span>
            <span class="ss">libvirt__dhcp_enabled: </span><span class="kp">false</span><span class="p">,</span>
            <span class="ss">libvirt__host_ip: </span><span class="s1">'10.0.0.1'</span>

       <span class="n">pxeclient</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">domain</span><span class="o">|</span>
          <span class="n">domain</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1000</span>
          <span class="n">boot_network</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'network'</span> <span class="o">=&gt;</span> <span class="s1">'foreman_managed'</span><span class="p">}</span>
          <span class="n">domain</span><span class="p">.</span><span class="nf">storage</span> <span class="ss">:file</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="s1">'100G'</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'qcow2'</span>
          <span class="n">domain</span><span class="p">.</span><span class="nf">boot</span> <span class="n">boot_network</span>
          <span class="n">domain</span><span class="p">.</span><span class="nf">boot</span> <span class="s1">'hd'</span>
        <span class="k">end</span>
      <span class="k">end</span>
</code></pre></div></div> <p>An example VM that is PXE booted from the <code class="language-plaintext highlighter-rouge">br1</code> device (which must already be configured in the host machine), and if that fails, is booted from the disk:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="ss">:pxeclient</span> <span class="k">do</span> <span class="o">|</span><span class="n">pxeclient</span><span class="o">|</span>
    <span class="n">pxeclient</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="ss">:public_network</span><span class="p">,</span>
      <span class="ss">dev: </span><span class="s1">'br1'</span><span class="p">,</span>
      <span class="ss">auto_config: </span><span class="kp">false</span>
    <span class="n">pxeclient</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">domain</span><span class="o">|</span>
      <span class="n">boot_network</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'dev'</span> <span class="o">=&gt;</span> <span class="s1">'br1'</span><span class="p">}</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">storage</span> <span class="ss">:file</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="s1">'100G'</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">boot</span> <span class="n">boot_network</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">boot</span> <span class="s1">'hd'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="using-kernel-and-initrd"> <a href="#using-kernel-and-initrd" class="anchor-heading" aria-labelledby="using-kernel-and-initrd"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using kernel and initrd </h2> <p>It’s possible to use a direct kernel boot to modify the kernel boot parameters used to boot the VM. This typically involves either downloading the kernel/initrd directly and placing somewhere locally for use, or making use of a tool such as <code class="language-plaintext highlighter-rouge">virt-copy-out</code> to extract the relevant files from a disk image file.</p> <p>Looking at a generic/fedora35 image with the following contents of /boot and /boot/grub2, it should be possible to copy out the kernel, initrd, and the grub.cfg file (provides a starting cmdline).</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">BOX_DIR</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">VAGRANT_HOME</span><span class="k">:-</span><span class="p">~/.vagrant.d</span><span class="k">}</span><span class="s2">/boxes/generic-VAGRANTSLASH-fedora35/4.1.10/libvirt"</span>
virt-ls <span class="nt">-a</span> <span class="k">${</span><span class="nv">BOX_DIR</span><span class="k">}</span>/box.img /boot/ /boot/grub2
.vmlinuz-5.18.19-100.fc35.x86_64.hmac
System.map-5.18.19-100.fc35.x86_64
config-5.18.19-100.fc35.x86_64
efi
grub2
initramfs-0-rescue-5cbe0655dcd04b46a88f5a424135fbb8.img
initramfs-5.18.19-100.fc35.x86_64.img
loader
symvers-5.18.19-100.fc35.x86_64.gz
vmlinuz-0-rescue-5cbe0655dcd04b46a88f5a424135fbb8
vmlinuz-5.18.19-100.fc35.x86_64
device.map
fonts
grub.cfg
grubenv
i386-pc
locale
</code></pre></div></div> <p>Assuming you run something like the following:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">BOX_DIR</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">VAGRANT_HOME</span><span class="k">:-</span><span class="p">~/.vagrant.d</span><span class="k">}</span><span class="s2">/boxes/generic-VAGRANTSLASH-fedora35/4.1.10/libvirt"</span>
virt-copy-out <span class="nt">-a</span> <span class="k">${</span><span class="nv">BOX_DIR</span><span class="k">}</span>/box.img <span class="se">\</span>
  /boot/vmlinuz-5.18.19-100.fc35.x86_64 <span class="se">\</span>
  /boot/initramfs-5.18.19-100.fc35.x86_64.img <span class="se">\</span>
  /boot/grub2/grub.cfg <span class="se">\</span>
  <span class="nb">.</span>
</code></pre></div></div> <p>The final Vagrantfile should contain something like the following:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"generic/fedora35"</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">kernel</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span><span class="si">}</span><span class="s2">/vmlinuz-5.18.19-100.fc35.x86_64"</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">initrd</span> <span class="o">=</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Dir</span><span class="p">.</span><span class="nf">pwd</span><span class="si">}</span><span class="s2">/initramfs-5.18.19-100.fc35.x86_64.img"</span>
    <span class="c1"># cmd_line is taken from the grub.cfg to ensure starting from a working value</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">cmd_line</span> <span class="o">=</span> <span class="s1">'root=/dev/mapper/fedora-root ro biosdevname=0 no_timer_check '</span> <span class="o">+</span>
        <span class="s1">'resume=/dev/mapper/fedora-swap rd.lvm.lv=fedora/root rd.lvm.lv=fedora/swap net.ifnames=0'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="ssh-access-to-vm"> <a href="#ssh-access-to-vm" class="anchor-heading" aria-labelledby="ssh-access-to-vm"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> SSH Access To VM </h2> <p>vagrant-libvirt supports vagrant’s <a href="https://docs.vagrantup.com/v2/vagrantfile/ssh_settings.html">standard ssh settings</a>.</p> <h2 id="forwarded-ports"> <a href="#forwarded-ports" class="anchor-heading" aria-labelledby="forwarded-ports"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Forwarded Ports </h2> <p>vagrant-libvirt supports Forwarded Ports via ssh port forwarding. Please note that due to a well known limitation only the TCP protocol is supported. For each <code class="language-plaintext highlighter-rouge">forwarded_port</code> directive you specify in your Vagrantfile, vagrant-libvirt will maintain an active ssh process for the lifetime of the VM. If your VM should happen to be rebooted, the SSH session will need to be re-established by halting the VM and bringing it back up.</p> <p>vagrant-libvirt supports an additional <code class="language-plaintext highlighter-rouge">forwarded_port</code> option <code class="language-plaintext highlighter-rouge">gateway_ports</code> which defaults to <code class="language-plaintext highlighter-rouge">false</code>, but can be set to <code class="language-plaintext highlighter-rouge">true</code> if you want the forwarded port to be accessible from outside the Vagrant host. In this case you should also set the <code class="language-plaintext highlighter-rouge">host_ip</code> option to <code class="language-plaintext highlighter-rouge">'*'</code> since it defaults to <code class="language-plaintext highlighter-rouge">'localhost'</code>.</p> <p>You can also provide a custom adapter to forward from by ‘adapter’ option. Default is <code class="language-plaintext highlighter-rouge">eth0</code>.</p> <p><strong>Internally Accessible Port Forward</strong></p> <p><code class="language-plaintext highlighter-rouge">config.vm.network :forwarded_port, guest: 80, host: 2000</code></p> <p><strong>Externally Accessible Port Forward</strong></p> <p><code class="language-plaintext highlighter-rouge">config.vm.network :forwarded_port, guest: 80, host: 2000, host_ip: "0.0.0.0"</code></p> <h2 id="forwarding-the-ssh-port"> <a href="#forwarding-the-ssh-port" class="anchor-heading" aria-labelledby="forwarding-the-ssh-port"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Forwarding the ssh-port </h2> <p>Vagrant-libvirt now supports forwarding the standard ssh-port on port 2222 from the localhost to allow for consistent provisioning steps/ports to be used when defining across multiple providers.</p> <p>To enable, set the following:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="c1"># Enable forwarding of forwarded_port with id 'ssh'.</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">forward_ssh_port</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Previously by default libvirt skipped the forwarding of the ssh-port because you can access the machine directly. In the future it is expected that this will be enabled by default once autocorrect support is added to handle port collisions for multi machine environments gracefully.</p> <h2 id="synced-folders"> <a href="#synced-folders" class="anchor-heading" aria-labelledby="synced-folders"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Synced Folders </h2> <p>Vagrant automatically syncs the project folder on the host to <code class="language-plaintext highlighter-rouge">/vagrant</code> in the guest. You can also configure additional synced folders.</p> <p>If the type is not specified, vagrant will attempt to select one based on the highest priority that is usable. This can mean that depending on whether you have the packages installed to support nfs and or rsync, you may experience different behaviour on different machines. Recommendation is to be explicit.</p> <p><strong>SECURITY NOTE:</strong> for remote Libvirt, nfs synced folders requires a bridged public network interface and you must connect to Libvirt via ssh.</p> <p><strong>NFS</strong></p> <p><code class="language-plaintext highlighter-rouge">vagrant-libvirt</code> supports <a href="https://www.vagrantup.com/docs/synced-folders/nfs">NFS</a> as with bidirectional synced folders.</p> <p>Example with NFS:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"nfs"</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong>RSync</strong></p> <p><code class="language-plaintext highlighter-rouge">vagrant-libvirt</code> supports <a href="https://www.vagrantup.com/docs/synced-folders/rsync">rsync</a> with unidirectional synced folders.</p> <p>Example with rsync:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"rsync"</span>
<span class="k">end</span>
</code></pre></div></div> <p><strong>9P</strong></p> <p><code class="language-plaintext highlighter-rouge">vagrant-libvirt</code> supports <a href="http://www.linux-kvm.org/page/VirtFS">VirtFS</a> (<a href="https://en.wikipedia.org/wiki/9P_\(protocol\)">9p or Plan 9</a>) with bidirectional synced folders.</p> <p>Difference between NFS and 9p is explained <a href="https://unix.stackexchange.com/questions/240281/virtfs-plan-9-vs-nfs-as-tool-for-share-folder-for-virtual-machine">here</a>.</p> <p>For 9p shares, a <code class="language-plaintext highlighter-rouge">mount: false</code> option allows to define synced folders without mounting them at boot.</p> <p>Example for <code class="language-plaintext highlighter-rouge">accessmode: "squash"</code> with 9p:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"9p"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">accessmode: </span><span class="s2">"squash"</span><span class="p">,</span> <span class="ss">owner: </span><span class="s2">"1000"</span>
<span class="k">end</span>
</code></pre></div></div> <p>Example for <code class="language-plaintext highlighter-rouge">accessmode: "mapped"</code> with 9p:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"9p"</span><span class="p">,</span> <span class="ss">disabled: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">accessmode: </span><span class="s2">"mapped"</span><span class="p">,</span> <span class="ss">mount: </span><span class="kp">false</span>
<span class="k">end</span>
</code></pre></div></div> <p>Further documentation on using 9p can be found in <a href="https://www.kernel.org/doc/Documentation/filesystems/9p.txt">kernel docs</a> and in <a href="https://wiki.qemu.org/Documentation/9psetup#Starting_the_Guest_directly">QEMU wiki</a>.</p> <p>Please do note that 9p depends on support in the guest and not all distros come with the 9p module by default.</p> <p><strong>Virtio-fs</strong></p> <p><code class="language-plaintext highlighter-rouge">vagrant-libvirt</code> supports <a href="https://virtio-fs.gitlab.io/">Virtio-fs</a> with bidirectional synced folders.</p> <p>For virtiofs shares, a <code class="language-plaintext highlighter-rouge">mount: false</code> option allows to define synced folders without mounting them at boot.</p> <p>So far, passthrough is the only supported access mode and it requires running the virtiofsd daemon as root.</p> <p>QEMU needs to allocate the backing memory for all the guest RAM as shared memory, e.g. <a href="https://libvirt.org/kbase/virtiofs.html#host-setup">Use file-backed memory</a> by enable <code class="language-plaintext highlighter-rouge">memory_backing_dir</code> option in <code class="language-plaintext highlighter-rouge">/etc/libvirt/qemu.conf</code>:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>memory_backing_dir <span class="o">=</span> <span class="s2">"/dev/shm"</span>
</code></pre></div></div> <p>Example for Libvirt &gt;= 6.2.0 (e.g. Ubuntu 20.10 with Linux 5.8.0 + QEMU 5.0 + Libvirt 6.6.0, i.e. NUMA nodes required) with virtiofs:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">numa_nodes</span> <span class="o">=</span> <span class="p">[{</span> <span class="ss">:cpus</span> <span class="o">=&gt;</span> <span class="s2">"0-1"</span><span class="p">,</span> <span class="ss">:memory</span> <span class="o">=&gt;</span> <span class="mi">8192</span><span class="p">,</span> <span class="ss">:memAccess</span> <span class="o">=&gt;</span> <span class="s2">"shared"</span> <span class="p">}]</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memorybacking</span> <span class="ss">:access</span><span class="p">,</span> <span class="ss">:mode</span> <span class="o">=&gt;</span> <span class="s2">"shared"</span>
  <span class="k">end</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"virtiofs"</span>
<span class="k">end</span>
</code></pre></div></div> <p>Example for Libvirt &gt;= 6.9.0 (e.g. Ubuntu 21.04 with Linux 5.11.0 + QEMU 5.2 + Libvirt 7.0.0, or Ubuntu 20.04 + <a href="https://launchpad.net/~savoury1/+archive/ubuntu/virtualisation">PPA enabled</a>) with virtiofs:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">cpus</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">8192</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memorybacking</span> <span class="ss">:access</span><span class="p">,</span> <span class="ss">:mode</span> <span class="o">=&gt;</span> <span class="s2">"shared"</span>
  <span class="k">end</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">synced_folder</span> <span class="s2">"./"</span><span class="p">,</span> <span class="s2">"/vagrant"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"virtiofs"</span>
<span class="k">end</span>
</code></pre></div></div> <p>Further documentation on using virtiofs can be found in <a href="https://virtio-fs.gitlab.io/index.html#howto">official HowTo</a> and in <a href="https://libvirt.org/kbase/virtiofs.html">Libvirt KB</a>.</p> <p>Please do note that virtiofs depends on:</p> <ul> <li>Host: Linux &gt;= 5.4, QEMU &gt;= 4.2 and Libvirt &gt;= 6.2 (e.g. Ubuntu 20.10)</li> <li>Guest: Linux &gt;= 5.4 (e.g. Ubuntu 20.04)</li> </ul> <h2 id="qemu-session-support"> <a href="#qemu-session-support" class="anchor-heading" aria-labelledby="qemu-session-support"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> QEMU Session Support </h2> <p>vagrant-libvirt supports using QEMU user sessions to maintain Vagrant VMs. As the session connection does not have root access to the system features which require root will not work. Access to networks created by the system QEMU connection can be granted by using the <a href="https://wiki.qemu.org/Features/HelperNetworking">QEMU bridge helper</a>. The bridge helper is enabled by default on some distros but may need to be enabled/installed on others.</p> <p>There must be a virbr network defined in the QEMU system session. The libvirt <code class="language-plaintext highlighter-rouge">default</code> network which comes by default, the vagrant <code class="language-plaintext highlighter-rouge">vagrant-libvirt</code> network which is generated if you run a Vagrantfile using the System session, or a manually defined network can be used. These networks can be set to autostart with <code class="language-plaintext highlighter-rouge">sudo virsh net-autostart &lt;net-name&gt;</code>, which’ll mean no further root access is required even after reboots.</p> <p>The QEMU bridge helper is configured via <code class="language-plaintext highlighter-rouge">/etc/qemu/bridge.conf</code>. This file must include the virbr you wish to use (e.g. virbr0, virbr1, etc). You can find this out via <code class="language-plaintext highlighter-rouge">sudo virsh net-dumpxml &lt;net-name&gt;</code>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>allow virbr0
</code></pre></div></div> <p>An example configuration of a machine using the QEMU session connection:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="c1"># Use QEMU session instead of system connection</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">qemu_use_session</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="c1"># URI of QEMU session connection, default is as below</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">uri</span> <span class="o">=</span> <span class="s1">'qemu:///session'</span>
    <span class="c1"># URI of QEMU system connection, use to obtain IP address for management, default is below</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">system_uri</span> <span class="o">=</span> <span class="s1">'qemu:///system'</span>
    <span class="c1"># Path to store Libvirt images for the virtual machine, default is as ~/.local/share/libvirt/images</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">storage_pool_path</span> <span class="o">=</span> <span class="s1">'/home/user/.local/share/libvirt/images'</span>
    <span class="c1"># Management network device, default is below</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">management_network_device</span> <span class="o">=</span> <span class="s1">'virbr0'</span>
  <span class="k">end</span>

  <span class="c1"># Public network configuration using existing network device</span>
  <span class="c1"># Note: Private networks do not work with QEMU session enabled as root access is required to create new network devices</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="ss">:public_network</span><span class="p">,</span> <span class="ss">:dev</span> <span class="o">=&gt;</span> <span class="s2">"virbr1"</span><span class="p">,</span>
      <span class="ss">:mode</span> <span class="o">=&gt;</span> <span class="s2">"bridge"</span><span class="p">,</span>
      <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">"bridge"</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="customized-graphics"> <a href="#customized-graphics" class="anchor-heading" aria-labelledby="customized-graphics"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Customized Graphics </h2> <p>vagrant-libvirt supports customizing the display and video settings of the managed guest. This is probably most useful for VNC-type displays with multiple guests. It lets you specify the exact port for each guest to use deterministically.</p> <p>Here is an example of using custom display options:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">graphics_port</span> <span class="o">=</span> <span class="mi">5901</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">graphics_ip</span> <span class="o">=</span> <span class="s1">'0.0.0.0'</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">video_type</span> <span class="o">=</span> <span class="s1">'qxl'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="tpm-devices"> <a href="#tpm-devices" class="anchor-heading" aria-labelledby="tpm-devices"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> TPM Devices </h2> <p>Modern versions of Libvirt support connecting to TPM devices on the host system. This allows you to enable Trusted Boot Extensions, among other features, on your guest VMs.</p> <p>To passthrough a hardware TPM, you will generally only need to modify the <code class="language-plaintext highlighter-rouge">tpm_path</code> variable in your guest configuration. However, advanced usage, such as the application of a Software TPM, may require modifying the <code class="language-plaintext highlighter-rouge">tpm_model</code>, <code class="language-plaintext highlighter-rouge">tpm_type</code> and <code class="language-plaintext highlighter-rouge">tpm_version</code> variables.</p> <p>The TPM options will only be used if you specify a TPM path or version. Declarations of any TPM options without specifying a path or version will result in those options being ignored.</p> <p>Here is an example of using the TPM options:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">tpm_model</span> <span class="o">=</span> <span class="s1">'tpm-tis'</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">tpm_type</span> <span class="o">=</span> <span class="s1">'passthrough'</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">tpm_path</span> <span class="o">=</span> <span class="s1">'/dev/tpm0'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>It’s also possible for Libvirt to start an emulated TPM device on the host. Requires <code class="language-plaintext highlighter-rouge">swtpm</code> and <code class="language-plaintext highlighter-rouge">swtpm-tools</code></p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">tpm_model</span> <span class="o">=</span> <span class="s2">"tpm-crb"</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">tpm_type</span> <span class="o">=</span> <span class="s2">"emulator"</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">tpm_version</span> <span class="o">=</span> <span class="s2">"2.0"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="smbios-system-information"> <a href="#smbios-system-information" class="anchor-heading" aria-labelledby="smbios-system-information"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> SMBIOS System Information </h2> <p>Libvirt allows to specify <a href="https://libvirt.org/formatdomain.html#smbios-system-information">SMBIOS System Information</a> like a base board or chassis manufacturer or a system serial number.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">sysinfo</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">'bios'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'vendor'</span><span class="p">:</span> <span class="s1">'Test Vendor'</span><span class="p">,</span>
        <span class="s1">'version'</span><span class="p">:</span> <span class="s1">'0.1.2'</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="s1">'system'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'manufacturer'</span><span class="p">:</span> <span class="s1">'Test Manufacturer'</span><span class="p">,</span>
        <span class="s1">'version'</span><span class="p">:</span> <span class="s1">'0.1.0'</span><span class="p">,</span>
        <span class="s1">'serial'</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="s1">'base board'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'manufacturer'</span><span class="p">:</span> <span class="s1">'Test Manufacturer'</span><span class="p">,</span>
        <span class="s1">'version'</span><span class="p">:</span> <span class="s1">'1.2'</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="s1">'chassis'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'manufacturer'</span><span class="p">:</span> <span class="s1">'Test Manufacturer'</span><span class="p">,</span>
        <span class="s1">'serial'</span><span class="p">:</span> <span class="s1">'AABBCCDDEE'</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="s1">'oem strings'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">'app1: string1'</span><span class="p">,</span>
        <span class="s1">'app1: string2'</span><span class="p">,</span>
        <span class="s1">'app2: string1'</span><span class="p">,</span>
        <span class="s1">'app2: string2'</span><span class="p">,</span>
      <span class="p">],</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="memory-balloon"> <a href="#memory-balloon" class="anchor-heading" aria-labelledby="memory-balloon"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Memory balloon </h2> <p>The configuration of the memory balloon device can be overridden. By default, libvirt will automatically attach a memory balloon; this behavior is preserved by not configuring any memballoon-related options. The memory balloon can be explicitly disabled by setting <code class="language-plaintext highlighter-rouge">memballoon_enabled</code> to <code class="language-plaintext highlighter-rouge">false</code>. Setting <code class="language-plaintext highlighter-rouge">memballoon_enabled</code> to <code class="language-plaintext highlighter-rouge">true</code> will allow additional configuration of memballoon-related options.</p> <p>Here is an example of using the memballoon options:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memballoon_enabled</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memballoon_model</span> <span class="o">=</span> <span class="s1">'virtio'</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memballoon_pci_bus</span> <span class="o">=</span> <span class="s1">'0x00'</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memballoon_pci_slot</span> <span class="o">=</span> <span class="s1">'0x0f'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="secure-encryption-virtualization-sev"> <a href="#secure-encryption-virtualization-sev" class="anchor-heading" aria-labelledby="secure-encryption-virtualization-sev"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Secure Encryption Virtualization (SEV) </h2> <p>Secure Encryption Virtualization is supported by libvirt and by the vagrant-libvirt provider but comes with several requirements.</p> <p>This mode has only been tested with q35 types of machines, so you’ll need an UEFI boot</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">loader</span> <span class="o">=</span> <span class="s2">"/usr/share/OVMF/OVMF_CODE.fd"</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">nvram</span> <span class="o">=</span> <span class="s2">"/path/to/ovmf/OVMF_VARS.fd"</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">machine_type</span> <span class="o">=</span> <span class="s1">'pc-q35-focal'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Read the libvirt documentaiton to understand what OVMF is and how to use it.</p> <p>Next, you’ll want to call the following methods:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">launchsecurity</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'sev'</span><span class="p">,</span> <span class="ss">:cbitpos</span> <span class="o">=&gt;</span> <span class="mi">47</span><span class="p">,</span> <span class="ss">:reducedPhysBits</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:policy</span> <span class="o">=&gt;</span> <span class="s2">"0x0003"</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memtune</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">"hard_limit"</span><span class="p">,</span> <span class="ss">:value</span> <span class="o">=&gt;</span> <span class="mi">2500000</span> <span class="c1"># Note here the value in kB (not in Mb)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Note that the value provided in the memtune <code class="language-plaintext highlighter-rouge">hard_limit</code> is in Kb by default. It should be higher than the one given in <code class="language-plaintext highlighter-rouge">libvirt.memory</code> (which is in Mb, by the way) by some amount (again, check out the <a href="documentation">https://libvirt.org/kbase/launch_security_sev.html</a>) to understand why.</p> <p>It is also necessary to explicitly define the memballoon for it to accept the iommu flag.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memballoon_enabled</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memballoon_model</span> <span class="o">=</span> <span class="s1">'virtio'</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memballoon_pci_bus</span> <span class="o">=</span> <span class="s1">'0x07'</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">memballoon_pci_slot</span> <span class="o">=</span> <span class="s1">'0x00'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>And finally, because the iommu flag has to be passed to the networks, you also need to set it explicitly:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="c1"># Management network only (the NAT'ed network provided by Vagrant)</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">management_network_driver_iommu</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>
  <span class="c1"># Example in defining a bridge</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">network</span> <span class="ss">:public_network</span><span class="p">,</span> <span class="ss">:dev</span> <span class="o">=&gt;</span> <span class="s2">"br0"</span><span class="p">,</span> <span class="ss">:bridge</span> <span class="o">=&gt;</span> <span class="s2">"br0"</span><span class="p">,</span> <span class="ss">:mode</span> <span class="o">=&gt;</span> <span class="s2">"bridge"</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s2">"bridge"</span><span class="p">,</span> <span class="ss">:driver_iommu</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="c1"># &lt;== Note here the additional flag</span>
<span class="k">end</span>
</code></pre></div></div> <p>Don’t forget that you’ll need an UEFI base box.</p> <h2 id="libvirt-communication-channels"> <a href="#libvirt-communication-channels" class="anchor-heading" aria-labelledby="libvirt-communication-channels"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Libvirt communication channels </h2> <p>For certain functionality to be available within a guest, a private communication channel must be established with the host. Two notable examples of this are the QEMU guest agent, and the Spice/QXL graphics type.</p> <p>Below is a simple example which exposes a virtio serial channel to the guest. Note: in a multi-VM environment, the channel would be created for all VMs.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">channel</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'unix'</span><span class="p">,</span> <span class="ss">:target_name</span> <span class="o">=&gt;</span> <span class="s1">'org.qemu.guest_agent.0'</span><span class="p">,</span> <span class="ss">:target_type</span> <span class="o">=&gt;</span> <span class="s1">'virtio'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>Below is the syntax for creating a spicevmc channel for use by a qxl graphics card.</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">channel</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'spicevmc'</span><span class="p">,</span> <span class="ss">:target_name</span> <span class="o">=&gt;</span> <span class="s1">'com.redhat.spice.0'</span><span class="p">,</span> <span class="ss">:target_type</span> <span class="o">=&gt;</span> <span class="s1">'virtio'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <p>These settings can be specified on a per-VM basis, however the per-guest settings will OVERRIDE any global ‘config’ setting. In the following example, we create 3 VMs with the following configuration:</p> <ul> <li><strong>controller</strong>: No channel settings specified, so we default to the provider setting of a single virtio guest agent channel.</li> <li><strong>node1</strong>: Override the channel setting, setting both the guest agent channel, and a spicevmc channel</li> <li><strong>node2</strong>: Override the channel setting, setting both the guest agent channel, and a ‘guestfwd’ channel. TCP traffic sent by the guest to the given IP address and port is forwarded to the host socket <code class="language-plaintext highlighter-rouge">/tmp/foo</code>. Note: this device must be unique for each VM.</li> </ul> <p>For example:</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">box</span> <span class="o">=</span> <span class="s2">"fedora/32-cloud-base"</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">channel</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'unix'</span><span class="p">,</span> <span class="ss">:target_name</span> <span class="o">=&gt;</span> <span class="s1">'org.qemu.guest_agent.0'</span><span class="p">,</span> <span class="ss">:target_type</span> <span class="o">=&gt;</span> <span class="s1">'virtio'</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"controller"</span> <span class="k">do</span> <span class="o">|</span><span class="n">controller</span><span class="o">|</span>
    <span class="n">controller</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">domain</span><span class="o">|</span>
        <span class="n">domain</span><span class="p">.</span><span class="nf">memory</span> <span class="o">=</span> <span class="mi">1024</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"node1"</span> <span class="k">do</span> <span class="o">|</span><span class="n">node1</span><span class="o">|</span>
    <span class="n">node1</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">domain</span><span class="o">|</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">channel</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'unix'</span><span class="p">,</span> <span class="ss">:target_name</span> <span class="o">=&gt;</span> <span class="s1">'org.qemu.guest_agent.0'</span><span class="p">,</span> <span class="ss">:target_type</span> <span class="o">=&gt;</span> <span class="s1">'virtio'</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">channel</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'spicevmc'</span><span class="p">,</span> <span class="ss">:target_name</span> <span class="o">=&gt;</span> <span class="s1">'com.redhat.spice.0'</span><span class="p">,</span> <span class="ss">:target_type</span> <span class="o">=&gt;</span> <span class="s1">'virtio'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">define</span> <span class="s2">"node2"</span> <span class="k">do</span> <span class="o">|</span><span class="n">node2</span><span class="o">|</span>
    <span class="n">node2</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">domain</span><span class="o">|</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">channel</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'unix'</span><span class="p">,</span> <span class="ss">:target_name</span> <span class="o">=&gt;</span> <span class="s1">'org.qemu.guest_agent.0'</span><span class="p">,</span> <span class="ss">:target_type</span> <span class="o">=&gt;</span> <span class="s1">'virtio'</span>
      <span class="n">domain</span><span class="p">.</span><span class="nf">channel</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">'unix'</span><span class="p">,</span> <span class="ss">:target_type</span> <span class="o">=&gt;</span> <span class="s1">'guestfwd'</span><span class="p">,</span> <span class="ss">:target_address</span> <span class="o">=&gt;</span> <span class="s1">'192.0.2.42'</span><span class="p">,</span> <span class="ss">:target_port</span> <span class="o">=&gt;</span> <span class="s1">'4242'</span><span class="p">,</span>
                     <span class="ss">:source_path</span> <span class="o">=&gt;</span> <span class="s1">'/tmp/foo'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <h2 id="custom-qemu-arguments-and-environment-variables"> <a href="#custom-qemu-arguments-and-environment-variables" class="anchor-heading" aria-labelledby="custom-qemu-arguments-and-environment-variables"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Custom QEMU arguments and environment variables </h2> <p>You can also specify multiple qemuargs arguments or qemuenv environment variables for qemu-system</p> <ul> <li><code class="language-plaintext highlighter-rouge">value</code> - Value</li> </ul> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Vagrant</span><span class="p">.</span><span class="nf">configure</span><span class="p">(</span><span class="s2">"2"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">vm</span><span class="p">.</span><span class="nf">provider</span> <span class="ss">:libvirt</span> <span class="k">do</span> <span class="o">|</span><span class="n">libvirt</span><span class="o">|</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">qemuargs</span> <span class="ss">:value</span> <span class="o">=&gt;</span> <span class="s2">"-device"</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">qemuargs</span> <span class="ss">:value</span> <span class="o">=&gt;</span> <span class="s2">"intel-iommu"</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">qemuenv</span> <span class="no">QEMU_AUDIO_DRV</span><span class="p">:</span> <span class="s1">'pa'</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">qemuenv</span> <span class="no">QEMU_AUDIO_TIMER_PERIOD</span><span class="p">:</span> <span class="s1">'150'</span>
    <span class="n">libvirt</span><span class="p">.</span><span class="nf">qemuenv</span> <span class="no">QEMU_PA_SAMPLES</span><span class="p">:</span> <span class="s1">'1024'</span><span class="p">,</span> <span class="no">QEMU_PA_SERVER</span><span class="p">:</span> <span class="s1">'/run/user/1000/pulse/native'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div> <hr> <footer> <div class="d-flex mt-2"> <p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/vagrant-libvirt/vagrant-libvirt/tree/main/docs/examples.markdown" id="edit-this-page">Edit this page on GitHub</a> </p> </div> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
